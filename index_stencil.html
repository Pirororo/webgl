<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGL TEST</title>

    <!-- 今回script.jsはonload外にイベントを書いたので、minMatrixb.jsはscript.jsより前に読んであげないとエラーする [new qtnIV() is not found] -->
    <script src="minMatrixb.js" type="text/javascript"></script>
    <script src="script_stencil.js" type="text/javascript"></script>

    <script id="vs" type="x-shader/x-vertex">
        attribute vec3 position;
        attribute vec3 normal;
        attribute vec4 color;
        attribute vec2 textureCoord;
        uniform   mat4 mvpMatrix;
        uniform   mat4 mMatrix;
        varying   vec3 vPosition;
        varying   vec3 vNormal;
        varying   vec4 vColor;
        varying   vec2 vTextureCoord;
        void main(void){
            vPosition = (mMatrix * vec4(position, 1.0)).xyz;
            vNormal = normal;
            vColor = color ;
            vTextureCoord = textureCoord;
            gl_Position = mvpMatrix * vec4(position, 1.0);
        }
    </script>
    <script id="fs" type="x-shader/x-fragment">
        precision mediump float;

        uniform   mat4 invMatrix;
        uniform   vec3 lightPosition;
        uniform   vec4 ambientColor;
        uniform   vec3 camPosition;
        uniform   sampler2D texture;
        varying   vec3 vPosition;
        varying   vec3 vNormal;
        varying   vec4 vColor;
        varying   vec2 vTextureCoord;
        void main(void){
            vec4 smpColor = texture2D(texture, vTextureCoord);
            vec3 lightVec = lightPosition - vPosition;
            vec3 invLight = normalize(invMatrix *vec4(lightVec, 0.0)).xyz;
            vec3 invEye = normalize(invMatrix *vec4(camPosition, 0.0)).xyz;
            vec3 halfLE = normalize(invLight + invEye);
            float diffuse = clamp(dot(vNormal, invLight), 0.1, 1.0) + 0.2;
            float specular = pow(clamp(dot(vNormal, halfLE), 0.1, 1.0), 10.0);
            vec4 destColor = vColor * smpColor * vec4(vec3(diffuse), 1.0) + vec4(vec3(specular), 1.0) + ambientColor;
            gl_FragColor = destColor; 
        }
    </script>
</head>
<body>
    <canvas id="canvas"></canvas>
</body>
</html>